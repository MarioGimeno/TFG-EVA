# 1. Actualizar paquetes del sistema
sudo apt update && sudo apt upgrade -y

# 2. Instalar herramientas básicas (curl para NodeSource y git para clonar)
sudo apt install -y curl git build-essential

# 3. Instalar Node.js LTS desde NodeSource
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
sudo apt install -y nodejs

# (Opcional) Verifica versiones
node -v
npm -v

token github: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
git clone https://MarioGimeno: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@github.com/MarioGimeno/TFG-Somos-M-s.git

Disco duro 

#!/bin/bash
# Formatear el disco
sudo mkfs.ext4 /dev/nvme1n1

# Crear punto de montaje
sudo mkdir -p /mnt/uploads

# Montar el disco en /mnt/uploads
sudo mount /dev/nvme1n1 /mnt/uploads

# Dar permisos al usuario ubuntu
sudo chown -R ubuntu:ubuntu /mnt/uploads

# Añadir al fstab para montaje automático tras reinicio
echo '/dev/nvme1n1  /mnt/uploads  ext4  defaults,nofail  0  2' | sudo tee -a /etc/fstab

# Verificar que el fstab no tiene errores y montar todo
sudo mount -a

# Mostrar el punto de montaje
df -h | grep /mnt/uploads

Para arreglar el bcrypt
cd ~/TFG-Somos-M-s/Back-end

# 1) Borra módulos y lockfile
rm -rf node_modules package-lock.json

# 2) Vuelve a instalar todo, compilando cualquier binding nativo en tu Linux
npm install

# 3) Fuerza la reconstrucción de bcrypt desde código fuente
npm rebuild bcrypt --build-from-source

# 4) Arranca de nuevo tu servidor
node server.js

dejarlo encendido

cd ~/TFG-Somos-M-s/Back-end
node server.js
nohup node server.js > server.log 2>&1 &
exit

iniciar
pm2 start server.js --name tfg-backend


restaurar
pm2 restart tfg-backend


logs 
tail -f server.log

Ver estado
pm2 status

Para ver logs
sudo tail -f /var/log/syslog | grep GH-Deploy

instalr docker
sudo apt update
sudo apt install -y docker.io
sudo usermod -aG docker ubuntu

ver logs docker
# Ver el contenedor en ejecución
sudo docker ps | grep tfg-backend 

# Ver sus últimos logs
sudo docker logs tfg-backend 





cd ~/TFG-Somos-M-s/Back-end

# Reemplaza completamente el contenido de keys.env con las variables deseadas:
cat <<EOF > keys.env
GOOGLE_APPLICATION_CREDENTIALS=/usr/src/app/dulcet-antler-439110-u5-5c1bc6f8def6.json
BUCKET_NAME=pruebabucketsomosmas
IV_SIZE=12
TAG_SIZE=16
SECRET_KEY=1234567890123456
MAGIC=CHNK
PGHOST=postgres.c5wcm68cai75.eu-north-1.rds.amazonaws.com
PGPORT=5432
PGUSER=postgres
PGPASSWORD=postgres
PGDATABASE=postgres
JWT_SECRET=123456789
JWT_EXPIRES=30d
REFRESH_EXPIRES=60d
TMPDIR=/mnt/uploads
SMTP_HOST=outlook
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=evaapptfg@outlook.com
SMTP_PASS=iurpsxrtilduleox
AWS_REGION=eu-north-1
AWS_ACCESS_KEY_ID=AKIA23KDBW7R3YDGRJMD
AWS_SECRET_ACCESS_KEY=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
SMTP_FROM=evaapptfg@outlook.com
EOF







cd ~/TFG-Somos-M-s/Back-end

# 1) Detén y borra cualquier contenedor ‘tfg-backend’ que exista
docker stop tfg-backend || true
docker rm -f tfg-backend || true

# 2) Borra la imagen antigua (por si existiera)
docker rmi -f tfg-backend:latest || true

# 3) Limpia Docker (contenedores parados, imágenes y volúmenes huérfanos)
docker system prune --volumes -f || true

# 4) Asegúrate de que Dockerfile y keys.env están en esta carpeta
if [ ! -f Dockerfile ]; then
  echo "ERROR: No se encuentra el Dockerfile en ~/TFG-Somos-M-s/Back-end"
  exit 1
fi
if [ ! -f keys.env ]; then
  echo "ERROR: No se encuentra keys.env en ~/TFG-Somos-M-s/Back-end"
  exit 1
fi

# 5) Reconstruye la imagen sin usar caché
docker build --no-cache -t tfg-backend:latest .

# 6) Libera el puerto 3000 (por si estuviera ocupado)
sudo lsof -ti tcp:3000 | xargs -r kill -9 || true

# 7) Inicia el contenedor en modo “detached”, cargando keys.env y montando el JSON de credenciales
docker run -d \
  --name tfg-backend \
  -p 3000:3000 \
  --env-file /home/ubuntu/TFG-Somos-M-s/Back-end/keys.env \
  -v /home/ubuntu/TFG-Somos-M-s/Back-end/dulcet-antler-439110-u5-5c1bc6f8def6.json:/usr/src/app/dulcet-antler-439110-u5-5c1bc6f8def6.json:ro \
  --restart unless-stopped \
  tfg-backend:latest

# 8) Verifica que el contenedor está “Up”
docker ps | grep tfg-backend

# 9) Muestra las últimas 50 líneas de logs para comprobar que arrancó sin errores
docker logs --tail 50 tfg-backend

# 10) (Opcional) Sigue los logs en tiempo real
docker logs -f tfg-backend
